# ASTRA Backend - Agent Brain ðŸ§ 

Node.js backend server for the ASTRA high-frequency policy-clearing terminal. This service integrates with Yellow Network and enforces on-chain compliance via ENS AstraResolver records.

---

## Quick Start

### 1. Install Dependencies

```bash
npm install
```

### 2. Configure Environment

```bash
cp .env.example .env
# Edit .env with your credentials
```

**Required Environment Variables:**
- `RPC_URL` - Ethereum RPC endpoint (Sepolia testnet recommended)
- `ASTRA_RESOLVER_ADDRESS` - Deployed AstraResolver contract address
- `YELLOW_WS` - Yellow Network Sandbox WebSocket URL
- `NODE_ENV` - Set to `development` for mock trade stream

### 3. Deploy AstraResolver Contract

Before running the server, deploy the AstraResolver contract:

```bash
cd ../contracts
forge script script/Deploy.s.sol --rpc-url $RPC_URL --broadcast
# Copy the deployed address to backend/.env
```

### 4. Start Server

```bash
# Development mode (with mock trade stream)
npm run dev

# Production mode
npm start
```

---

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ASTRA Agent Brain                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Yellow Networkâ”‚        â”‚ Ethereum RPC     â”‚         â”‚
â”‚  â”‚   WebSocket   â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ (AstraResolver)  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚         â”‚                          â”‚                    â”‚
â”‚         â”‚                          â”‚                    â”‚
â”‚         â–¼                          â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚       complianceChecker()                â”‚          â”‚
â”‚  â”‚  - Fetch ENS policy records              â”‚          â”‚
â”‚  â”‚  - Validate trade limits                 â”‚          â”‚
â”‚  â”‚  - Enforce drawdown/liquidity rules      â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  Express API (Port 3000)                 â”‚          â”‚
â”‚  â”‚  - GET  /health                          â”‚          â”‚
â”‚  â”‚  - POST /check-compliance                â”‚          â”‚
â”‚  â”‚  - GET  /policy/:ensNode                 â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Yellow Network Integration

### Connecting to Yellow Sandbox WebSocket

The `connectToYellow()` function in `server.js` establishes a WebSocket connection to Yellow Network:

```javascript
const YELLOW_SANDBOX_WS = 'wss://sandbox.yellownetwork.io/ws';

async function connectToYellow() {
  // Yellow SDK integration point
  yellowClient = new YellowClient(YELLOW_SANDBOX_WS);
  yellowClient.on('trade', handleYellowTrade);
}
```

**Note:** The actual Yellow Network SDK (@erc7824/nitrolite) integration may differ. Replace the mock implementation with the official SDK when available.

### Yellow Network Resources

- **Sandbox Docs:** https://docs.yellownetwork.io/sandbox
- **WebSocket API:** https://docs.yellownetwork.io/ws-api
- **State Channels:** https://docs.yellownetwork.io/state-channels

---

## AstraResolver ENS Integration

### Fetching Policy Records

The `complianceChecker()` function fetches agent policy records from the deployed AstraResolver contract:

```javascript
const [drawdown, maxTrade, minLiq, viban] = 
  await astraResolver.getAllRecords(ensNode);
```

### AstraResolver ABI Location

The ABI is auto-generated by Foundry and can be found at:

```
../contracts/out/AstraResolver.sol/AstraResolver.json
```

**To extract the ABI:**

```bash
cd ../contracts
cat out/AstraResolver.sol/AstraResolver.json | jq '.abi' > ../backend/AstraResolver.abi.json
```

Then update `server.js`:

```javascript
const ASTRA_RESOLVER_ABI = require('./AstraResolver.abi.json');
```

### Required ABI Functions

The backend uses these AstraResolver functions:

| Function | Purpose |
|----------|---------|
| `getAllRecords(bytes32 node)` | Fetch all policy records at once |
| `uintRecord(bytes32 node, string key)` | Fetch individual uint256 record |
| `textRecord(bytes32 node, string key)` | Fetch individual string record |

---

## Compliance Checker Logic

### Policy Validation

The compliance checker enforces three rules:

1. **Max Trade Size** - `trade.amount <= policy.maxTrade`
2. **Min Liquidity** - `trade.liquidity >= policy.minLiq`
3. **VIBAN Present** - `policy.viban.length > 0`

### Example Trade Validation

```javascript
const result = await complianceChecker(
  ethers.namehash('agent1.astra.eth'),
  {
    amount: ethers.parseEther('1.5'),
    liquidity: ethers.parseEther('0.8'),
    pair: 'ETH/USDT'
  }
);

console.log(result.compliant); // true or false
```

---

## API Endpoints

### GET /health

Health check endpoint.

**Response:**
```json
{
  "status": "ok",
  "yellowConnected": true,
  "resolver": "0x..."
}
```

### POST /check-compliance

Manually check a trade for compliance.

**Request Body:**
```json
{
  "ensNode": "0x...",  // ENS namehash
  "trade": {
    "amount": "1500000000000000000",
    "liquidity": "800000000000000000"
  }
}
```

**Response:**
```json
{
  "compliant": true,
  "checks": {
    "maxTradeValid": true,
    "liquidityValid": true,
    "vibanPresent": true
  },
  "policy": {
    "drawdown": "500",
    "maxTrade": "2000000000000000000",
    "minLiq": "500000000000000000",
    "viban": "DE89370400440532013000"
  }
}
```

### GET /policy/:ensNode

Get policy records for a specific agent.

**Response:**
```json
{
  "node": "0x...",
  "policy": {
    "drawdown": "500",
    "maxTrade": "2.0",
    "minLiq": "0.5",
    "viban": "DE89370400440532013000"
  }
}
```

---

## Mock Trade Stream (Development)

When `NODE_ENV=development`, the server generates mock trades every 500ms for testing:

```javascript
function mockTradeStream() {
  setInterval(() => {
    const mockTrade = {
      amount: ethers.parseEther((Math.random() * 2).toFixed(4)),
      liquidity: ethers.parseEther((Math.random() * 1).toFixed(4)),
      pair: 'ETH/USDT'
    };
    complianceChecker(mockNode, mockTrade);
  }, 500);
}
```

**To disable:** Set `NODE_ENV=production`

---

## Testing

### Manual Testing

```bash
# Start server in dev mode
npm run dev

# In another terminal, test the API
curl http://localhost:3000/health

curl -X POST http://localhost:3000/check-compliance \
  -H "Content-Type: application/json" \
  -d '{
    "ensNode": "0x...",
    "trade": {
      "amount": "1500000000000000000",
      "liquidity": "800000000000000000"
    }
  }'
```

### ENS Namehash Generation

To convert an ENS name to a namehash:

```javascript
const { ethers } = require('ethers');
const node = ethers.namehash('agent1.astra.eth');
console.log(node); // 0x...
```

---

## Production Deployment

### Recommended Setup

1. **Deploy to Cloud Service** (Railway, Render, Fly.io)
2. **Use Production RPC** (Alchemy, Infura mainnet)
3. **Secure Environment Variables** (use secrets management)
4. **Enable Health Monitoring** (UptimeRobot, Datadog)
5. **Scale WebSocket Connections** (use connection pooling)

### Environment Variables for Production

```bash
NODE_ENV=production
PORT=3000
RPC_URL=https://eth-mainnet.g.alchemy.com/v2/YOUR_API_KEY
ASTRA_RESOLVER_ADDRESS=0x... # Mainnet deployment
YELLOW_WS=wss://prod.yellownetwork.io/ws
```

---

## Troubleshooting

### "Cannot connect to Yellow Network"

- Verify `YELLOW_WS` URL is correct
- Check firewall/network restrictions
- Ensure Yellow Network Sandbox is accessible

### "Contract call reverted"

- Verify `ASTRA_RESOLVER_ADDRESS` is correct
- Ensure contract is deployed on the target network
- Check RPC_URL points to the correct network

### "Invalid ENS node"

- Use `ethers.namehash()` to generate proper node hash
- Ensure the ENS name is registered and has policies set

---

## Next Steps

1. **Integrate Yellow SDK** - Replace mock implementation with actual SDK
2. **Add Database** - Store historical compliance checks
3. **WebSocket Events** - Emit real-time compliance results to frontend
4. **Advanced Validation** - Add drawdown tracking and risk scoring
5. **Multi-Agent Support** - Handle multiple agents concurrently

---

## License

MIT
